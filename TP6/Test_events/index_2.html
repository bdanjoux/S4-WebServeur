<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Events </title>
  </head>
  <body>
    <canvas id="MyCanvas" width='800' height='800'></canvas>
  </body>
<script src="../../jquery-3.3.1.js"></script>
<script src="jquery.hotkeys.js"></script>
<script id="myScript">
  var mainloop = function() {
        updateGame();
        drawGame();
    };

    function updateGame(){
      manTick++;
      mechantTick++;
      if(manTick/6>1){
        manTick=0;
        updateMan();
      }
      if(mechantTick/10>1){
        mechantTick=0;
        updateMechant();
      }
    }

    function drawGame(){
      context.clearRect(0,0,canvas.width,canvas.height);
      animateFond();
      animateMan();
      animateMechant();
    }

    var animFrame = window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame    ||
            window.oRequestAnimationFrame      ||
            window.msRequestAnimationFrame     ||
            null ;

    var recursiveAnim = function() {
        mainloop();
        animFrame( recursiveAnim );
    };

    // start the mainloop
    animFrame( recursiveAnim );

    var canvas = document.getElementById('MyCanvas');
    var context = canvas.getContext('2d');
    var manWalking = false;
    var manTick = 0;
    var mechantTick = 0;
    var keysDown = [false,false,false,false];
    var manPosition =[0,0];

  var manImg = new Image();
  var manLoaded=false;
  manImg.addEventListener('load', function() {
    manLoaded=true;
  }, false);
  manImg.src = 'hero_walk_cycle_spritesheet_by_mrnoobtastic-d3defej.png';
  manIndex = [0,0];


  var mechantImg = new Image();
  var mechantLoaded = false;
  mechantImg.addEventListener('load', function() {
    mechantLoaded=true;
  }, false);
  mechantImg.src = 'mechant.png';
  var Mechants = [[10,10,0],[100,100,1],[300,10,0],[-1,-1,0],[-1,-1,0],[-1,-1,0]];

  var fondImg = new Image();
  var fondLoaded = false;
  fondImg.addEventListener('load', function() {
    fondLoaded=true;
  }, false);
  fondImg.src = 'fond.png';



  window.addEventListener("keydown", keystroke, false);
  window.addEventListener("keyup", keyuphandler, false);


  
  function up(){
    //console.log("up");
    manWalking=true;
    keysDown[0]=true;
  }

  function down(){
    //console.log("down");
    manWalking=true;
    keysDown[1]=true;
  }

  function left(){
    //console.log("left");
    manWalking=true;
    keysDown[2]=true;
  }

  function right(){
    //console.log("right");
    manWalking=true;
    keysDown[3]=true;
  }

  function keystroke(event){
    
    //console.log(event.key);
    switch(event.key){
      case 'ArrowUp'    : up()      ;event.preventDefault();break;
      case 'ArrowDown'  : down()    ;event.preventDefault();break;
      case 'ArrowLeft'  : left()    ;event.preventDefault();break;
      case 'ArrowRight' : right()   ;event.preventDefault();break;
    }
    
  }

  function keyuphandler(event){
    switch(event.key){
      case 'ArrowUp'    : keysDown[0]=false      ;break;
      case 'ArrowDown'  : keysDown[1]=false      ;break;
      case 'ArrowLeft'  : keysDown[2]=false      ;break;
      case 'ArrowRight' : keysDown[3]=false      ;break;
    }  
    event.preventDefault();
    if(!keysDown[0] && !keysDown[1] && !keysDown[2] && !keysDown[3]){
      manWalking=false;
    }
  }

  function updateMan(){
    if(manWalking){
      manIndex[0]=(manIndex[0]+1)%4;
      var count = 0;
      if(keysDown[0]){
        count++;
      }
      if(keysDown[1]){
        count++;
      }
      if(keysDown[2]){
        count++;
      }
      if(keysDown[3]){
        count++;
      }
      var defaultMovement = 10;
      if(count === 1 || count === 2){
          if(keysDown[0] && keysDown[2]){
            manPosition[0]-=defaultMovement;
            manPosition[1]-=defaultMovement;
            manIndex[1]=0;
            //manIndex[1]=3
          }
          else if(keysDown[0] && keysDown[3]){
            manPosition[0]+=defaultMovement;
            manPosition[1]-=defaultMovement;
            manIndex[1]=1;
            //manIndex[1]=3
          }
          else if(keysDown[1] && keysDown[2]){
            manPosition[0]-=defaultMovement;
            manPosition[1]+=defaultMovement;
            manIndex[1]=0;
            //manIndex[1]=2;
          }
          else if(keysDown[1] && keysDown[3]){
            manPosition[0]+=defaultMovement;
            manPosition[1]+=defaultMovement;
            manIndex[1]=1;
            //manIndex[1]=2;
          }
          else if(keysDown[0]){
            manIndex[1]=3;
            manPosition[1]-=defaultMovement;
            console.log(manPosition[1]);
          }
          else if(keysDown[1]){
            manIndex[1]=2;
            manPosition[1]+=defaultMovement;
            console.log(manPosition[1]);
          }
          else if(keysDown[2]){
            manIndex[1]=0;
            manPosition[0]-=defaultMovement;
            console.log(manPosition[0]);
          }
          else if(keysDown[3]){
            manIndex[1]=1;
            manPosition[0]+=defaultMovement;
            console.log(manPosition[0]);
          }
      }
    }
  }

  function updateMechant(){
    var k =0;
    var standardSpeed = 5;
    for(k=0;k<Mechants.length;k++){

      // Shift it's state
      if(Mechants[k][2] == 1){
        Mechants[k][2]=0; 
      }else{
        Mechants[k][2]=1; 
      }

      // Move it

      var X = manPosition[0] - Mechants[k][0];
      var Y = manPosition[1] - Mechants[k][1];
      var dist = Math.sqrt(X**2+Y**2);
      Mechants[k][0]=Mechants[k][0]+standardSpeed*X/dist;
      Mechants[k][1]=Mechants[k][1]+standardSpeed*Y/dist;

    }
  }



  function animateFond(){
    if(fondLoaded){
      context.drawImage(fondImg,0,0,1004,655,0,0,canvas.width,canvas.height); 
    }
  }

  function animateMan(){
    if(manLoaded){
      context.drawImage(manImg,manIndex[0]*128,manIndex[1]*128,128,128,manPosition[0],manPosition[1],128,128); 
    }
  }


function animateMechant(){
    if(mechantLoaded){
      var k =0;
      for(k=0;k<Mechants.length;k++){
       if(Mechants[k][0]!=-1 && Mechants[k][1]!=-1){
          context.drawImage(mechantImg,170/2*Mechants[k][2],0,170/2,125,Mechants[k][0],Mechants[k][1],170/2,125); 
        }
      }
    }
  }

  function addMechant(){

  }

</script>